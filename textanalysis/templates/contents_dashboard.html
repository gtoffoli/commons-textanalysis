{% extends "base.html" %}
{% load staticfiles %}
{% load i18n %}
{% block head_title %}{% trans "contents dashboard"|capfirst %}{% endblock %}
{% block extra_style %}
<link rel="shortcut icon" href="{% static "commons/img/ta_dashboard.ico" %}" type="image/x-icon">
<link rel="apple-touch-icon" href="{% static "commons/img/ta_dashboard_icon.png" %}" type="image/png">
<link rel="stylesheet" href="{% static "vue_apps/src/assets/index.css" %}">
<link rel="stylesheet" href="{% static "commons/css/commons_vue.css" %}">
<link rel="stylesheet" href="{% static "vue_apps/vddl/vddl.css" %}">
<link rel="stylesheet" href="{% static "vue_apps/vddl/vddl.css" %}">
<link rel="stylesheet" href="{% static "vue_apps/dialog/vuejs-dialog.min.css" %}">
<link rel="stylesheet" href="https://unpkg.com/vue-multiselect@2.1.6/dist/vue-multiselect.min.css">
<style>
hr {
  margin:0;
  padding-top: 5px;
  padding-bottom: 10px;
}
.list-e > div {
  width: 100%;
  height: auto;
  margin: 0 0 0.1em 0;
  background: #fff;
}
{% if project_name %}
.panel-head {
  background-color: #FABE66;
  border: 1px solid #FABE66;
  border-bottom-width: 0;
}
{% else %}
div.panel-head {
  background-color: #67AE73;
  border:1px solid #67AE73;
  border-bottom-width: 0;
  color: white;
}
{%endif%}
div.panel-head {
  padding: 5px 10px;
  margin-top:30px;
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
}
div.lps, div.shared_lps, div.personal_lps {
  padding:5px 10px;
  background-color: #CB4F98;
  border:1px solid #CB4F98;
  color: white;
  font-weight:600;
}
div.oers, div.shared_oers, div.personal_oers {
  padding: 5px 10px;
  background-color: #008BD2;
  border: 1px solid #008BD2;
  color: white;
  font-weight:600;
}
div.docs {
  padding: 5px 10px;
  background-color: #C2B280;
  border: 1px solid #C2B280;
  color: white;
  font-weight:600;
}
div.lps a, div.shared_lps a, div.personal_lps a, .oers a, div.shared_oers a, div.personal_oers a, div.docs a {
  color: white;
}
div.lps a:hover, div.shared_lps a:hover, div.personal_lps a:hover, div.oers a:hover, div.shared_oers a:hover, div.personal_oers a:hover, div.docs a:hover {
  color: #ebeded;
}
div.lps + div.vddl-list, div.shared_lps + div.vddl-list, div.personal_lps + div.vddl-list {
    border: 1px solid #CB4F98;
}
div.oers + div.vddl-list, div.shared_oers + div.vddl-list, div.personal_oers + div.vddl-list {
    border: 1px solid #008BD2;
}
div.docs + div.vddl-list {
  border: 1px solid #C2B280;
}
div.vddl-list {
    padding:0;
    background-color: white;
    border-top-width: 0;
    color:#333;
    font-weight: normal;
}
.list-e > div .vddl-draggable {
  padding:3px 10px 3px 10px;
  display: grid;
  grid-template-columns: auto 8% 8% 8%;
  font-size:90%;
}
div.lps + div.vddl-list > div.vddl-draggable,
div.shared_lps + div.vddl-list > div.vddl-draggable,
div.personal_lps + div.vddl-list > div.vddl-draggable {
  border-bottom: 1px dotted #CB4F98;
}
div.oers + div.vddl-list > div.vddl-draggable,
div.shared_oers + div.vddl-list > div.vddl-draggable,
div.personal_oers + div.vddl-list > div.vddl-draggable {
  border-bottom: 1px dotted #008BD2;
}
div.lps + div.vddl-list > div.vddl-draggable:hover,
div.shared_lps + div.vddl-list > div.vddl-draggable:hover,
div.personal_lps + div.vddl-list > div.vddl-draggable:hover {
  background-color:#FDF7FB;
}
div.oers + div.vddl-list > div.vddl-draggable:hover,
div.shared_oers + div.vddl-list > div.vddl-draggable:hover,
div.personal_oers + div.vddl-list > div.vddl-draggable:hover {
  background-color: #F2FBFF;
}
div.docs + div.vddl-list > div.vddl-draggable {
  border: 1px dotted #C2B280;
}
div.docs + div.vddl-list > div.vddl-draggable:hover {
  background-color: #FBF9F4; //#F8F5EF;
}
div.panel-head-corpora {
  padding: 5px 10px;
  // margin-top:30px;
  border-top-left-radius: 4px;
  border-top-right-radius: 4px;
  background-color: #67AE73;
  border: 1px solid #67AE73;
  color: white;
}
.list-r > div {
  width:100%;
  margin: 0 0 0.1em 0;
  background: #fff;
  border: 1px solid #B2B2B2;
  border-top-width:0;
}
.list-r > div .panel-heading-corpus {
  display: grid;
  grid-template-columns: auto 5% 5% 5% 10% 10% 5% 5% 3%;
  color: #fff;
  background: #B2B2B2;
}
.list-r > div .panel-heading-corpus a {
  color: #fff;
  background: #B2B2B2;
}
.list-r > div .panel-heading-corpus a:hover {
  color: #ebeded;
}
.list-r > div .subheading-corpus {
  padding:3px 10px; 
  display: grid;
  grid-template-columns: auto 5% 5% 5% 10% 10% 5% 5% 3%;
  background: #f9f9f9;
  font-size: 90%; 
}
.list-r > div .vddl-draggable {
  padding:3px 10px;
  display: grid;
  grid-template-columns: auto 5% 5% 5% 10% 10% 5% 5% 3%;
  border-bottom: 1px dotted #B2B2B2;
  font-size:90%;
}
.list-r > div .vddl-draggable:hover {
  background-color: #F4F4F4;
}
.list-e > div .panel-heading-c0 div,
.list-e > div .vddl-draggable div.
.list-r > div .panel-heading-corpus div,
.list-r > div .subheading-corpus div,
.list-r > div .vddl-draggable div {
  padding-right:3px;
}
.upperCase {
  text-transform:uppercase;
}
a.analyzeText:before {
  content: "TA";
  border: 1px solid #337ab7;
  border-radius: 3px;
  padding: 0 4px;
  color: #337ab7;
  font-size: 10px;
  font-weight: 600;
}
a.analyzeText-white:before {
  content: "TA";
  border: 1px solid #fff;
  border-radius: 3px;
  padding: 0 4px;
  color: #fff;
  font-size: 10px;
  font-weight: 600;
}
ul.ta-menu li, ul.ta-menu li a { display: inline; font-size: 12px; line-height: 1;}

.btn-outline-dark {
  color: #333;
  background-color: #fff;
  border-color: #B2B2B2;
}

.btn-outline-dark:hover {
  color: #fff;
  background-color: #B2B2B2;
  border-color: #B2B2B2;
}

.btn-outline-dark:focus, .btn-outline-dark.focus {
  box-shadow: 0 0 0 0.2rem rgba(52, 58, 64, 0.5);
}
.box-result {
  width:100%;
  margin: 1em 1em 1em 0;
  font-size:90%;
}

</style>
{% endblock extra_style %}

{% block extra_head %}
    <script src="https://use.fontawesome.com/d391635073.js"></script>
    <script src="{% static "nlp/js/jquery.min.js" %}"></script>
{% comment %}
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/sortablejs@1.13.0/Sortable.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/vuedraggable@2.24.3/src/vuedraggable.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vddl@0.7.1/dist/vddl.js"></script>
    <script src="https://unpkg.com/http-vue-loader"></script>
{% endcomment %}
    <script src="{% static "vue/vue.js" %}"></script>
    <script type="module" src="{% static "vue_apps/sortable/Sortable.js" %}"></script>
    <script type="module" src="{% static "vue_apps/vuedraggable/vuedraggable.js" %}"></script>
    <script src="{% static "vue_apps/vddl/vddl.js" %}"></script>
    <script type="text/javascript" src="{% static "vue_apps/dialog/vuejs-dialog.min.js" %}"></script>
    <script type="text/javascript" src="{% static "vue_apps/dialog/vuejs-dialog-mixin.min.js" %}"></script> 
    <script src="https://unpkg.com/vue-multiselect@2.1.6"></script>
{% endblock extra_head %}

{% block body_class %}contents_dashboard{% endblock %}

{% block user %}{% endblock user %}

{% block nav_vue %}
  {% include "_header_bar.html" %}
{% endblock nav_vue %}

{% block body %}
<div class="panel-head">
{% if project_name %}
    <h3 class="pull-left marginT5 marginB5 demiBold">{% trans "contents dashboard"|capfirst %}</h3>
    <h4 class="pull-right marginT5 marginB0"><span class="demiBold"><a href="/project/{{ project_slug }}/" title="{% trans "show project" %}"><i class="fa fa-group font07em c-{% if proj_type_name in 'roll,ment' %}white{% else %}demiblack{% endif %}" aria-hidden="true"></i></a> {{ project_name }} </span><span style="font-size:90%">{% trans "and its sub-projects" %}</span></h4>
{% else %}
    <h3 class="pull-left marginT5 marginB5 demiBold">{% trans "contents dashboard"|capfirst %}</h3>
    <h4 class="pull-right marginT10 marginB0 demiBold">{{ user.get_display_name }}</h4>
{% endif %}
<div style="clear:both"></div>
</div>

{% verbatim %}
    <div id="app" class="marginB20">
        <div class="list-e">
          <div v-for="resource_list in resource_lists">
            <div :class="resource_list.list_id">
				<a v-on:click.stop="toggle_content(resource_list);" href="#" :title="label_expand_collapse">
				<i v-if="!resource_list.open" class="fa fa-plus-square"></i><i v-if="resource_list.open" class="fa fa-minus-square"></i></a>
				{{ resource_list.label }}</div>
            <template v-if="resource_list.open">
            <vddl-list :list=resource_list.items
              class="box-scroll box-small"
              :allowed-types=[resource_list.list_id]
              :inserted="handleInserted"
              :dragover="handleDragover"
              :drop="handleDrop">
                <vddl-draggable v-for="r_item in resource_list.items"
                :key="resource_list.list_id+r_item.obj_id"
                :type=resource_list.list_id
                :draggable=r_item
                :index=r_item['index']
                :wrapper=resource_list.items
                effect-allowed="copy"
                :selected="selectedEvent"
                :dragstart="handleDragstart"
                :dragend="handleDragend"
                :canceled="handleCanceled"
                :moved="handleMoved"
                :class="{'selected': resource_list.selected === r_item}"
                >
                  <div><span style="cursor:grab">{{ r_item.label }}</span></div>
                  <div class="upperCase c-white">{{ r_item.obj_type }}</div>
                  <div><a :href=r_item.url target="_text">{{ r_item.obj_id }}</a></div>
                  <a v-on:click.stop="toggle_menu(r_item);"><i class="fa fa-bars" style="cursor: pointer;"></i></a>
                  <ul v-if="r_item.active">

                    <li><a :href="'/textanalysis/dependency/'+r_item.obj_type+'/'+r_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_dependency }}</a></li>
                    <li><a :href="'/textanalysis/context/'+r_item.obj_type+'/'+r_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_context }}</a></li>
                    <li><a :href="'/textanalysis/wordlists/'+r_item.obj_type+'/'+r_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_wordlists }}</a></li>
                    <li><a :href="'/textanalysis/annotations/'+r_item.obj_type+'/'+r_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_annotation }}</a></li>
                    <li><a :href="'/textanalysis/nounchunks/'+r_item.obj_type+'/'+r_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_nounchunks }}</a></li>
                    <li><a :href="'/textanalysis/readability/'+r_item.obj_type+'/'+r_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_readability }}</a></li>
                    <li><a :href="'/textanalysis/cohesion/'+r_item.obj_type+'/'+r_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_cohesion }}</a></li>
                    <li><a :href="'/textanalysis/summarization/'+r_item.obj_type+'/'+r_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_summarization }}</a></li>
                    <li><a :href="'/textanalysis/dashboard/'+r_item.obj_type+'/'+r_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_analysis }}</a></li>
                  </ul>
                </vddl-draggable>
            </vddl-list>
            </template>
          </div>
        </div>
        <hr>

        <!--h4 class="text-center"><small>{{ label_corpora }}</small> {{ label_user }}</h4-->
        <div class="panel-head-corpora">
            <h3 class="pull-left marginT5 marginB5 demiBold">{{ label_corpora }}</h3>
            <h4 class="pull-right marginT5 marginB5 demiBold">{{ label_user }}</h4>
            <div style="clear:both"></div>
        </div>

        <div class="list-r">
          <div v-for="corpus in corpora" :key="corpus.file_key">
            <div class="panel-heading-corpus padding510">
              <div><template v-if="!corpus.active">
				   <a href="#" v-on:click.stop="toggle_content(corpus);" :title="label_expand_collapse">
					   <i v-if="!corpus.open" class="fa fa-plus-square"></i><i v-if="corpus.open" class="fa fa-minus-square"></i></a>
				   </template>
              	   <span class="demiBold" v-if="corpus.items.length==0">{{ label_empty_corpus }}</span>
              	   <span class="demiBold" v-else>{{ label_corpus }}</span>
                   <span class="demiBold">{{ corpus.file_key }}</span>
              </div>
              <div></div>
              <div></div>
              <div><a v-on:click.stop="toggle_menu(corpus);" :title="label_show_hide_corpus_menu"><i class="fa fa-bars" style="cursor: pointer;"></i></a></div>
              <div><a v-if="!corpus.active" v-on:click.stop="promptWebResourceUrl(corpus);" :title="label_add_item_from_web"><i class="fa fa-cloud-download" style="cursor: pointer;"></i></a></div>
              <div><a v-if="!corpus.active && !corpus.open" v-on:click.stop="toggle_filter(corpus);" :title="label_manage_domains"><i class="fa fa-filter" style="cursor: pointer;"></i></a></div>
              <div></div>
              <div class="text-center"><a href="#" v-on:click="deleteCorpus(corpus.file_key);" :title="label_delete_corpus"><i class="fa fa-trash bold"></i></a></div>
            </div>
              <ul v-if="corpus.active" style="font-size: 0.8em;">
                <li><a :href="'/textanalysis/corpus/'+corpus.file_key+'/'" target="_blank" rel="noopener nofollow">{{ label_corpus_dashboard }}</a></li>
                <li><a :href="'/textanalysis/wordlists/'+corpus.file_key+'/'" target="_blank" rel="noopener nofollow">{{ label_wordlists }}</a></li>
              </ul>
            <template v-if="corpus.open">
            <div class="test">
              <div class="subheading-corpus">
                <div>title of corpus item</div>
                <div>type</div>
                <div>id</div>
                <div>lang</div>
                <div style="white-space:nowrap;">n. tokens</div>
                <div style="white-space:nowrap;">n. words</div>
                <div></div>
                <div></div>
                <div></div>
              </div>
              <vddl-list :list=corpus.items
              class="box-scroll box-small"
              :corpus="corpus.file_key"
              :inserted="handleInserted"
              :dragover="handleDragover"
              :drop="handleDrop">
                <vddl-draggable v-for="c_item in corpus.items"
                :key="corpus.file_key+c_item.obj_id"
                class="vddl-draggable-corpus"
                :type=corpus.list_id
                :allowed-types=all_types
                :draggable=c_item
                :index=c_item['index']
                :wrapper=corpus.items
                effect-allowed="move"
                :selected="selectedEvent"
                :dragstart="handleDragstart"
                :dragend="handleDragend"
                :canceled="handleCanceled"
                :moved="handleMoved"
                :class="{'selected': corpus.selected === c_item}"
                >
                  <div><span style="cursor:default">{{ c_item.label }}</span></div>
                  <div class="upperCase">{{ c_item.obj_type }}</div>
                  <div><template v-if="c_item.obj_type=='web'"><a :href="c_item.url" :title="c_item.url" target="_blank"><i class="fa fa-external-link font07em" aria-hidden="true"></i></a></template>
                       <template v-else=>{{ c_item.obj_id }}</template></div>
                  <div class="upperCase">{{ c_item.language }}</div>
                  <div>{{ c_item.n_tokens }}</div>
                  <div>{{ c_item.n_words }}</div>
                  <a v-on:click.stop="toggle_menu(c_item);" :title="label_show_hide_item_menu"><i class="fa fa-bars" style="cursor: pointer;"></i></a>
                  <div class="text-center"><a href="#" v-on:click="removeItem(corpus.file_key, c_item.obj_type, c_item.obj_id);" :title="label_remove_item"><i class="fa fa-trash demibold"></i></a></div>
                  <br v-if="c_item.active">
                  <ul v-if="c_item.active" style="font-size: 0.8em;">
                    <li><a :href="'/textanalysis/dependency/'+corpus.file_key+'/'+c_item.obj_type+'/'+c_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_dependency }}</a></li>
                    <li><a :href="'/textanalysis/context/'+corpus.file_key+'/'+c_item.obj_type+'/'+c_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_context }}</a></li>
                    <li><a :href="'/textanalysis/wordlists/'+corpus.file_key+'/'+c_item.obj_type+'/'+c_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_wordlists }}</a></li>
                    <li><a :href="'/textanalysis/annotations/'+corpus.file_key+'/'+c_item.obj_type+'/'+c_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_annotation }}</a></li>
                    <li><a :href="'/textanalysis/nounchunks/'+corpus.file_key+'/'+c_item.obj_type+'/'+c_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_nounchunks }}</a></li>
                    <li><a :href="'/textanalysis/readability/'+corpus.file_key+'/'+c_item.obj_type+'/'+c_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_readability }}</a></li>
                    <li><a :href="'/textanalysis/cohesion/'+corpus.file_key+'/'+c_item.obj_type+'/'+c_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_cohesion }}</a></li>
                    <li><a :href="'/textanalysis/summarization/'+corpus.file_key+'/'+c_item.obj_type+'/'+c_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_summarization }}</a></li>
                    <li><a :href="'/textanalysis/dashboard/'+corpus.file_key+'/'+c_item.obj_type+'/'+c_item.obj_id+'/'" target="_blank" rel="noopener nofollow">{{ label_analysis }}</a></li>
                  </ul>
               </vddl-draggable>
              </vddl-list>
            </div>
            </template>
          </div>
        </div>
        <hr>
        <div><template v-if="is_authenticated">
              <button v-if="!empty_corpus" v-on:click="newSelected();" class="btn btn-outline-dark marginR10">{{ label_new_corpus }}</button>
        	  <button v-if="compare" v-on:click="compareSelected();" class="btn btn-outline-dark">{{ label_similarity }}</button>
          </template>  
          <template v-else>{{ msg_anonymous }}</template>  
        </div>
        <div id="result" class="box-result">{{ result }}</div>
    </div>
{% endverbatim %}
{% endblock body %}

{% block footer_base %}
{% endblock footer_base %}

{% block script_base %}
<script type="text/javascript" src="{% static "js/bootstrap.min.js" %}"></script>

<script type="text/javascript">
// see: https://github.com/Godofbrowser/vuejs-dialog
// Tell Vue to install the VuejsDialog plugin.
window.Vue.use(VuejsDialog.main.default)

var app = new Vue({
    name: 'contents_dashboard',
    components: {
      // see https://danielkelly.io/blog/renderless-vue-dialog/
      // see https://medium.com/@jamesweee/using-vue-js-single-file-component-without-module-bundlers-aea58d892ad9
      // 'dialog': window.httpVueLoader('/static/vue_apps/renderless-dialog/components/Dialogue.vue')
      // Vue.component('vue-simple-context-menu', VueSimpleContextMenu)
    },
    el: '#app',
    data: {
      project_id: {{project_id}},
      is_authenticated: {% if user.is_authenticated %}true{% else %}false{% endif %},
      resource_lists: {lps: {list_id: 'lps', label: 'LPs', items: [], selected: null},  shared_lps: {list_id: 'shared_lps', label: 'Shared LPs', items: [], selected: null}, personal_lps: {list_id: 'personal_lps', label: 'Personal LPs', items: [], selected: null},oers: {list_id: 'oers', label: 'OERs', items: [], selected: null}, shared_oers: {list_id: 'shared_oers', label: 'Shared OERs', items: [], selected: null}, personal_oers: {list_id: 'personal_oers', label: 'Personal OERs', items: [], selected: null}, docs: {list_id: 'docs', label: 'DOCs', items: [], selected: null} },
      resource_list: {list_id: 'list', label: 'LIST', items: [], selected: null},
      corpora: [],
      corpus: {list_id: 'corpus', label: 'Corpus', items: [], domains: [], selected: null},
      // item: {active: false},
      // items: [],
      // selected: null,
      result: '',
      compare: false,
      all_types: ['lps', 'shared_lps', 'personal_lps', 'oers', 'shared_oers', 'personal_oers', 'docs', 'corpus'],
      source_id: '',
      msg_anonymous: '{% trans "it seems that you are not logged in."|capfirst %}',
      label_user: '{{user.get_display_name}}',
      label_corpora: '{% trans "corpora"|capfirst %}',
      label_expand_collapse: '{% trans "expand / collapse" %}',
      label_selected: '{% trans "selected resources"|capfirst %}',
      label_corpus: '{% trans "corpus"|capfirst %}',
      label_empty_corpus: '{% trans "empty corpus"|capfirst %}',
      label_new_corpus: '{% trans "new corpus"|capfirst %}',
      label_delete_corpus: '{% trans "delete corpus"|capfirst %}',
      label_add_item_from_web: '{% trans "add item to corpus from web resource"|capfirst %}',
      label_add_item_from_web_prompt: '{% trans "insert the URL of a web resource, then click on"|capfirst %}',
      label_remove_item: '{% trans "remove item"|capfirst %}',
      label_show_hide_corpus_menu: '{% trans "show / hide corpus menu"|capfirst %}',
      label_show_hide_item_menu: '{% trans "show / hide item menu"|capfirst %}',
      label_manage_domains:  '{% trans "manage associated subject domains"|capfirst %}',
      label_similarity: '{% trans "similarity"|capfirst %}',
      label_corpus_dashboard: '{% trans "Corpus Dashboard" %}',
      label_dependency: '{% trans "Dependency parse" %}',
      label_context: '{% trans "Keywords In Context" %}',
      label_wordlists: '{% trans "Word Lists by POS" %}',
      label_annotation: '{% trans "Annotated text" %}',
      label_nounchunks: '{% trans "Named Entities" %}',
      label_readability: '{% trans "Text Readability" %}',
      label_cohesion: '{% trans "Text Cohesion" %}',
      label_summarization: '{% trans "Text Summarization" %}',
      label_analysis: '{% trans "Text Analysis Dashboard" %}',
      label_confirm_deletion: '{% trans "confirm deletion" %}',
    },
    computed: {
      empty_corpus: {
        get() {
          for (i=0; i<this.corpora.length; i++)
            if (this.corpora[i].items.length==0) return true;
          return false;
        },
        set(value) {}
      },
    },
    methods: {
		get_file_key: function(targets) {
	      for (let i = 0; i < targets.length; i++) {
	        target = targets[i];
		    if (target.hasAttribute('corpus')) {
		      file_key = target.attributes.corpus.value;
	          console.log('file_key:', file_key);
		      return file_key;
		    };
		  };
		  return null;
		},
      toggle_menu: function(item) {
        Vue.set(item, 'active', !item.active);
        this.$forceUpdate();
      },
      toggle_content: function(item) {
        Vue.set(item, 'open', !item.open);
        this.$forceUpdate();
      },
      toggle_filter: function(item) {
        Vue.set(item, 'filter', !item.filter);
        this.$forceUpdate();
      },
      findEmptyCorpus: function() {
        var empty = false;
        for (corpus in this.corpora)
          if (!corpus.items)
            return corpus;
        return null;
      },
      corpusAddResourceItem: function(file_key, url) {
        data = {file_key: file_key, url: url};
        fetch('/ajax_resource_to_item/', {
          method: 'POST',
          headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
          body: JSON.stringify(data)
       	})
        .then(response => response.json())
        .then(data => {
       	// add a few attributes to the item and possibly update the file_key with real language code
          for (var i=0; i<this.corpora.length; i++) {
            var corpus = this.corpora[i];
            if (corpus.file_key == file_key) {
              if (data['error']) {
                this['result'] = data['error'];
                this.corpora[i].items.pop();
                this.$forceUpdate();
                return;
              }
              this.corpora[i].file_key = data['file_key'];
              for (var j=0; j<corpus.items.length; j++) {
                var item = corpus.items[j];
                if (item.obj_type==obj_type && item.obj_id==obj_id) {
                  this.corpora[i].items[j].language = data['language'];
                  this.corpora[i].items[j].n_tokens = data['n_tokens'];
                  this.corpora[i].items[j].n_words = data['n_words'];
                  this.$forceUpdate();
                }
              }
            }
          }
        })
        .catch(err => (this['result'] = err))
       },
       selectedEvent: function(item) {
        console.log(':v-draggable: selected');
        this.selected = item;
        // var key = item.list_id;
        // this.lists[key].selected = item;
      },
      handleDragstart(target) {
        console.log(':v-draggable: dragstart');
        console.log(target);
      },
      handleDragend(drop_effect, target) {
        console.log(':v-draggable: dragend');
        console.log(drop_effect, target);
      },
      handleCanceled() {
        console.log(':v-draggable: canceled');
      },
      handleMoved(item) {
        console.log(':v-draggable: moved');
        console.log(item);
        const { index, list } = item;
        list.splice(index, 1);
      },
      handleDragover() {
        console.log(':v-list: handleDragover');
      },
      // handleInserted() {
      handleInserted(event, index, transferredObject) {          
        console.log(':v-list: inserted');
        console.log(event);
        console.log(event['list']);
        // update the index of all items in the target list
        for (i=0; i<event['list'].length; i++) {
          console.log(event['list'][i]['index']);
          event['list'][i]['index'] = i
          console.log(event['list'][i]['index']);
        };
      },
      handleDrop(data) {
        console.log('handleDrop');
        // var target = data.event.path[0];
        // https://stackoverflow.com/questions/39245488/event-path-is-undefined-running-in-firefox
  	    // var file_key = target.attributes.corpus.value;
        var targets = data.event.composedPath();
        console.log('handleDrop', targets);
        var file_key = this.get_file_key(targets);
        const { index, list, item } = data;
        console.log('handleDrop', file_key, item, index);
        var obj_type = item.obj_type;
        var obj_id = item.obj_id;
        // change the id
        item['id'] = new Date().getTime();
        list.splice(index, 0, item);
        // if the list is of type corpus, update the corpus in the server and refresh the local view
        if (file_key !== undefined) {
          data = {file_key: file_key, item: item, index: index};
          fetch('/ajax_insert_item/', {
            method: 'POST',
            headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
            body: JSON.stringify(data)
         	})
          .then(response => response.json())
          .then(data => {
         	// add a few attributes to the item and possibly update the file_key with real language code
            for (var i=0; i<this.corpora.length; i++) {
              var corpus = this.corpora[i];
              if (corpus.file_key == file_key) {
                if (data['error']) {
                  this['result'] = data['error'];
                  this.corpora[i].items.pop();
                  this.$forceUpdate();
                  return;
                }
                this.corpora[i].file_key = data['file_key'];
                for (var j=0; j<corpus.items.length; j++) {
                  var item = corpus.items[j];
                  if (item.obj_type==obj_type && item.obj_id==obj_id) {
                    this.corpora[i].items[j].language = data['language'];
                    this.corpora[i].items[j].n_tokens = data['n_tokens'];
                    this.corpora[i].items[j].n_words = data['n_words'];
                    this.$forceUpdate();
                  }
                }
              }
         	}
          })
          .catch(err => (this['result'] = err))
        }
      },
      newSelected() {
        console.log('newSelected');
        fetch('/ajax_new_corpus/', {
          method: 'POST',
          headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
          body: JSON.stringify({})
       	})
        .then(response => response.json())
        .then(data => {
            this['file_key'] = data['file_key'];
            this['corpora'].push({list_id: 'corpus', file_key: this['file_key'], items: [], selected: true});
        	}
         )
        .catch(err => (this['result'] = err))
      },
      preprocessSelected() {
        console.log('preprocessSelected');
        fetch('/ajax_make_corpus/', {
          method: 'POST',
          headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
          body: JSON.stringify(app.corpus)
       	})
        .then(response => response.json())
        .then(data => {
            this['corpus']['items'] = data['result'];
            this['file_key'] = data['file_key'];
            this['corpora'].push(this['file_key']);
        	}
          )
        .catch(err => (this['result'] = err))
      },
      deleteCorpus(file_key) {
        console.log('deleteCorpus');
        if(confirm(this.label_confirm_deletion)) {
          data = {file_key: file_key};
          fetch('/ajax_delete_corpus/', {
            method: 'POST',
            headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
            body: JSON.stringify(data)
       	  })
          .then(response => response.json())
          .then(data => {
            // remove from corpora list the corpus with the associated file_key
            if (data['file_key']==file_key)
              for (var i=0; i<this.corpora.length; i++)
                if (this.corpora[i].file_key==file_key)
                  this.corpora.splice(i,1);
          })
          .catch(err => (this['result'] = err))
        }
      },
      removeItem(file_key, obj_type, obj_id) {
        console.log('removeItem');
        data = {file_key: file_key, obj_type: obj_type, obj_id: obj_id};
        fetch('/ajax_remove_item/', {
          method: 'POST',
          headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
          body: JSON.stringify(data)
       	})
        .then(response => response.json())
        .then(data => {
          // identify the corpus
          for (i=0; i<this['corpora'].length; i++)
            if (this['corpora'][i].file_key == file_key)
              break;
          // update the index of all items in the target corpus
          for (j=0; j<this['corpora'][i].items.length; j++)
            if (this['corpora'][i].items[j].obj_type == obj_type && this['corpora'][i].items[j].obj_id == obj_id) {
              this['corpora'][i].items.splice(j, 1);
              break;
            }
        })
        .catch(err => (this['result'] = err))
      },
      contextSelected() {
        console.log('contextSelected');
        window.open("/context_dashboard/"+this['file_key']+"/", "_context");
      },
      compareSelected() {
        console.log('compareSelected');
        fetch('/ajax_compare_resources/', {
          method: 'POST',
          headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
          body: JSON.stringify(app.corpus)
       	})
        .then(response => response.json())
        .then(data => (this['result'] = data['result']))
        .catch(err => (this['result'] = err))
      },
      promptWebResourceUrl(corpus) {
        this.$dialog
        .prompt({
          title: this.label_add_item_from_web,
          body: "",
        }, {
          promptHelp: this.label_add_item_from_web_prompt + ' "[+:okText]"'
        })
        .then(dialog => {
          // Triggered when proceed button is clicked: process the user response
          url = dialog.data;
          console.log(url);
          this.corpusAddResourceItem(corpus.file_key, url);
        })
        .catch(() => {
          // Triggered when dialog is dismissed by user
          console.log('Prompt dismissed');
        });
      }
    },

    mounted: function () {
      this['corpus']['items'] = [];
      data = {project_id: this.project_id};
      fetch('/ajax_contents/', {
        method: 'POST',
        // headers: {"X-Requested-With": "XMLHttpRequest"}, // this is just a patch
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        // set all properties from response data into app data
        for (var key in data) {
          if (key == 'corpora') {
            this.corpora = data[key];
            this.empty_corpus = this.findEmptyCorpus();
          }
          else {
            var resource_list = this.resource_lists[key];
            var items = data[key];
            if (items.length == 0)
              delete this.resource_lists[key];
            else {
              resource_list.items = items;
              for (index = 0; index<resource_list.items.length; index++) {
            	resource_list.items[index].list_id = key;
            	resource_list.items[index].selected = false;
            	resource_list.items[index].index = index;
            	resource_list.items[index].active = false;
            	resource_list.items[index].open = false;
              }
            }
          }
    	}
      })
      .catch(err => (console.log(err)))
    },
    updated: function () {
    },
});
</script>
{% endblock script_base %}
